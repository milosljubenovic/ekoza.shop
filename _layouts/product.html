---
layout: default
---

<div class="bg-gradient-to-b from-slate-900 to-slate-800 min-h-screen py-16">
<div class="container mx-auto px-4 py-8">
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 mb-8">
    <!-- Product Images Gallery -->
    <div>
      <div class="mb-4">
        <img id="mainImage" src="{{ page.images[0] }}" alt="{{ page.title }}" class="w-full h-96 object-cover rounded-2xl shadow-2xl border border-slate-700 cursor-pointer hover:opacity-90 transition-opacity" onclick="openImageModal('{{ page.images[0] }}')">
      </div>
      <div class="grid grid-cols-4 gap-3">
        {% for image in page.images %}
        <img src="{{ image }}" alt="{{ page.title }}" 
             class="w-full h-24 object-cover rounded-xl cursor-pointer hover:opacity-75 thumbnail-image border-2 border-slate-700 hover:border-purple-500 transition-all"
             onclick="changeMainImage('{{ image }}')">
        {% endfor %}
      </div>
    </div>

    <!-- Product Details -->
    <div class="bg-gradient-to-br from-slate-800 to-slate-700 rounded-2xl p-8 border border-slate-600">
      <h1 class="text-4xl font-bold text-white mb-6">{{ page.title }}</h1>
      <div class="flex items-center mb-6">
        <span id="displayPrice" class="text-4xl font-bold text-gradient">{{ page.base_price }} RSD</span>
        {% if page.old_price %}
        <span class="text-xl text-gray-500 line-through ml-4">{{ page.old_price }} RSD</span>
        {% endif %}
      </div>

      <div class="mb-6">
        <p class="text-gray-300 text-lg">{{ page.description }}</p>
      </div>

      <!-- Category -->
      <div class="mb-6">
        <span class="text-sm text-gray-400">Kategorija:</span>
        <a href="{{ '/k' | relative_url }}ategorije/{{ page.category | slugify }}" class="text-purple-400 hover:text-purple-300 ml-2 font-semibold">
          {{ page.category }}
        </a>
      </div>

      <!-- Colors -->
      {% if page.colors %}
      <div class="mb-6">
        <label class="block text-sm font-semibold text-white mb-3">Boja: <span id="selectedColorName" class="text-purple-400"></span></label>
        <div class="flex flex-wrap gap-4 max-h-32 overflow-y-auto p-1" id="colorOptions">
          {% for color in page.colors %}
          <label class="cursor-pointer relative transition-all">
            <input type="radio" 
                   name="color" 
                   value="{{ color.name }}" 
                   data-price-modifier="{{ color.price_modifier }}"
                   {% if color.image %}data-image="{{ color.image }}"{% endif %}
                   class="hidden color-radio"
                   {% if forloop.first %}checked{% endif %}>
            {% if color.image %}
            <div class="w-14 h-14 rounded-full border-3 border-slate-600 hover:border-purple-400 transition-all flex items-center justify-center color-swatch overflow-hidden bg-white"
                 title="{{ color.name }}{% if color.price_modifier > 0 %} (+{{ color.price_modifier }} RSD){% endif %}">
              <img src="{{ color.image }}" alt="{{ color.name }}" class="w-full h-full object-cover">
              <svg class="w-8 h-8 text-purple-500 absolute inset-0 m-auto hidden check-icon drop-shadow-lg" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
              </svg>
            </div>
            {% else %}
            <div class="w-14 h-14 rounded-full border-3 border-slate-600 hover:border-purple-400 transition-all flex items-center justify-center color-swatch"
                 style="background-color: {{ color.hex }};"
                 title="{{ color.name }}{% if color.price_modifier > 0 %} (+{{ color.price_modifier }} RSD){% endif %}">
              <svg class="w-6 h-6 text-white hidden check-icon" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
              </svg>
            </div>
            {% endif %}
          </label>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- Sizes/Variations -->
      {% if page.sizes %}
      <div class="mb-6">
        <label class="block text-sm font-semibold text-white mb-3">Veličina: <span id="selectedSizeName" class="text-purple-400"></span></label>
        <div class="flex flex-wrap gap-3" id="sizeOptions">
          {% for size in page.sizes %}
          <label class="cursor-pointer">
            <input type="radio" 
                   name="size" 
                   value="{{ size.name }}" 
                   data-price-modifier="{{ size.price_modifier }}"
                   class="hidden size-radio"
                   {% if forloop.first %}checked{% endif %}>
            <div class="px-5 py-3 border-2 border-slate-600 rounded-xl hover:border-purple-500 size-swatch text-white font-semibold transition-all hover:bg-slate-700">
              {{ size.name }}{% if size.price_modifier > 0 %} <span class="text-xs text-purple-400">+{{ size.price_modifier }} RSD</span>{% endif %}
            </div>
          </label>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- Customization Options -->
      {% if page.supports_embroidery or page.supports_name_embroidery %}
      <div class="mb-6 bg-gradient-to-br from-slate-800/50 to-slate-700/50 rounded-2xl p-6 border border-slate-600">
        <h3 class="text-lg font-bold text-white mb-4 flex items-center">
          <svg class="w-5 h-5 mr-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
          </svg>
          Personalizacija
        </h3>
        
        {% if page.supports_embroidery %}
        <div class="mb-4">
          <label class="flex items-start cursor-pointer group">
            <input type="checkbox" id="embroideryCheckbox" class="mt-1 w-5 h-5 text-purple-600 bg-slate-900 border-slate-600 rounded focus:ring-purple-500">
            <div class="ml-3 flex-1">
              <span class="text-white font-semibold group-hover:text-purple-400 transition-colors">Dodaj vez (logo/slika)</span>
              <p class="text-sm text-gray-400 mt-1">Dodajte svoj logo ili sliku na proizvod</p>
              <span class="text-purple-400 font-bold text-sm">+{{ site.customization.embroidery_price }} RSD</span>
            </div>
          </label>
          
          <div id="embroideryContainer" class="hidden mt-3 ml-8">
            <button type="button" onclick="openEmbroideryGallery()" class="w-full px-4 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl hover:from-purple-500 hover:to-pink-500 transition-all font-semibold flex items-center justify-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              Izaberi Dizajn iz Galerije
            </button>
            <div id="selectedEmbroideryPreview" class="hidden mt-3 p-3 bg-slate-900 rounded-xl border border-slate-600">
              <p class="text-xs text-gray-400 mb-2">Izabrani dizajn:</p>
              <div class="flex items-center gap-3">
                <img id="selectedEmbroideryImage" src="" alt="" class="w-16 h-16 object-contain bg-white rounded-lg">
                <div class="flex-1">
                  <p id="selectedEmbroideryName" class="text-white font-semibold"></p>
                  <button type="button" onclick="clearEmbroiderySelection()" class="text-xs text-red-400 hover:text-red-300 mt-1">Ukloni</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        
        {% if page.supports_name_embroidery %}
        <div class="mb-4">
          <label class="flex items-start cursor-pointer group">
            <input type="checkbox" id="nameEmbroideryCheckbox" class="mt-1 w-5 h-5 text-purple-600 bg-slate-900 border-slate-600 rounded focus:ring-purple-500">
            <div class="ml-3 flex-1">
              <span class="text-white font-semibold group-hover:text-purple-400 transition-colors">Dodaj vez imena/teksta</span>
              <p class="text-sm text-gray-400 mt-1">Personalizujte sa imenom ili tekstom</p>
              <span class="text-purple-400 font-bold text-sm">+{{ site.customization.name_embroidery_price }} RSD</span>
            </div>
          </label>
          
          <div id="nameInputContainer" class="hidden mt-3 ml-8 space-y-3">
            <div>
              <input type="text" 
                     id="customNameInput" 
                     placeholder="Unesite ime ili tekst (max 20 karaktera)"
                     maxlength="20"
                     class="w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-xl text-white placeholder-gray-500 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
              <p class="text-xs text-gray-400 mt-1">Ime će biti izvezeno na proizvodu</p>
            </div>
            
            <div>
              <label class="block text-sm font-semibold text-white mb-2">Izbor pisma:</label>
              <div class="flex gap-3">
                {% for font in site.customization.font_options %}
                <label class="cursor-pointer flex-1">
                  <input type="radio" 
                         name="fontStyle" 
                         value="{{ font.value }}" 
                         class="hidden font-radio"
                         {% if forloop.first %}checked{% endif %}>
                  <div class="px-4 py-2 border-2 border-slate-600 rounded-xl hover:border-purple-500 font-swatch text-white text-center font-semibold transition-all hover:bg-slate-700">
                    {{ font.name }}
                  </div>
                </label>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
      {% endif %}

      <!-- Quantity -->
      <div class="mb-6">
        <label class="block text-sm font-semibold text-white mb-3">Količina:</label>
        <div class="flex items-center gap-3">
          <button onclick="decrementQuantity()" class="px-5 py-3 bg-slate-700 rounded-xl hover:bg-slate-600 text-white font-bold text-xl transition-all">-</button>
          <input type="number" id="quantity" value="1" min="1" class="w-24 text-center bg-slate-800 border border-slate-600 rounded-xl py-3 text-white font-bold text-lg">
          <button onclick="incrementQuantity()" class="px-5 py-3 bg-slate-700 rounded-xl hover:bg-slate-600 text-white font-bold text-xl transition-all">+</button>
        </div>
      </div>

      <!-- Stock Status -->
      <div class="mb-6">
        {% if page.in_stock %}
        <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-lg">
          <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
          </svg>
          Na stanju
        </span>
        {% else %}
        <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold bg-gradient-to-r from-red-500 to-pink-500 text-white shadow-lg">
          Trenutno nije dostupno
        </span>
        {% endif %}
      </div>

      <!-- Add to Cart Button -->
      <button onclick="addToCartWithOptions()" 
              class="w-full btn-primary-modern text-lg py-4 mb-6"
              {% unless page.in_stock %}disabled{% endunless %}>
        <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
        </svg>
        Dodaj u korpu
      </button>

      <!-- Product Details Accordion -->
      <div class="border-t border-slate-600 pt-6">
        <div class="mb-4">
          <h3 class="text-xl font-bold mb-4 text-white">Detalji proizvoda</h3>
          <div class="prose prose-sm text-gray-300">
            {{ content }}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<!-- Embroidery Gallery Modal -->
<div id="embroideryGalleryModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4">
  <div class="bg-gradient-to-br from-slate-800 to-slate-700 rounded-2xl border border-slate-600 max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col">
    <!-- Modal Header -->
    <div class="p-6 border-b border-slate-600 flex items-center justify-between">
      <h2 class="text-2xl font-bold text-white">Galerija Dizajna za Vez</h2>
      <button onclick="closeEmbroideryGallery()" class="text-gray-400 hover:text-white transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    
    <!-- Search and Filter -->
    <div class="p-6 border-b border-slate-600">
      <div class="flex flex-col sm:flex-row gap-4">
        <!-- Search -->
        <div class="flex-1">
          <input type="text" 
                 id="embroiderySearch" 
                 placeholder="Pretraži dizajne..."
                 oninput="filterEmbroideryDesigns()"
                 class="w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-xl text-white placeholder-gray-500 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
        </div>
        
        <!-- Category Filter -->
        <div class="flex gap-2 overflow-x-auto">
          {% for category in site.customization.embroidery_categories %}
          <button onclick="filterByCategory('{{ category.value }}')" 
                  data-category="{{ category.value }}"
                  class="category-filter-btn px-4 py-2 bg-slate-900 border border-slate-600 rounded-xl text-white text-sm font-semibold hover:border-purple-500 transition-all whitespace-nowrap {% if forloop.first %}border-purple-500 bg-purple-600{% endif %}">
            {{ category.name }}
          </button>
          {% endfor %}
        </div>
      </div>
    </div>
    
    <!-- Gallery Grid -->
    <div class="flex-1 overflow-y-auto p-6">
      <div id="embroideryGalleryGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
        {% for design in site.data.embroidery_designs %}
        <div class="embroidery-design-item cursor-pointer group" 
             data-category="{{ design.category }}"
             data-name="{{ design.name | downcase }}"
             onclick="selectEmbroideryDesign('{{ design.id }}', '{{ design.name }}', '{{ design.image }}')">
          <div class="bg-slate-900 rounded-xl p-4 border-2 border-slate-600 hover:border-purple-500 transition-all group-hover:scale-105">
            <div class="aspect-square bg-white rounded-lg mb-2 flex items-center justify-center overflow-hidden">
              <img src="{{ design.image }}" alt="{{ design.name }}" class="w-full h-full object-contain">
            </div>
            <p class="text-white text-sm font-semibold text-center truncate">{{ design.name }}</p>
          </div>
        </div>
        {% endfor %}
      </div>
      
      <div id="noResultsMessage" class="hidden text-center py-12">
        <p class="text-gray-400 text-lg">Nema pronađenih dizajna</p>
      </div>
    </div>
  </div>
</div>

<!-- Image Lightbox Modal -->
<div id="imageLightboxModal" class="hidden fixed inset-0 bg-black bg-opacity-95 z-50 flex items-center justify-center p-4" onclick="closeImageModal(event)">
  <button onclick="closeImageModal()" class="absolute top-4 right-4 text-white hover:text-purple-400 transition-colors z-10">
    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
    </svg>
  </button>
  
  <div class="relative max-w-7xl max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
    <div id="imageContainer" class="overflow-auto" style="max-height: 90vh;">
      <img id="lightboxImage" src="" alt="" class="transition-transform duration-200" style="transform-origin: center center;">
    </div>
    
    <!-- Zoom Controls -->
    <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex items-center gap-2 bg-slate-800/90 rounded-full px-4 py-2 backdrop-blur-sm">
      <button onclick="zoomOut()" class="text-white hover:text-purple-400 transition-colors p-2">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path>
        </svg>
      </button>
      <span id="zoomLevel" class="text-white font-semibold min-w-16 text-center">100%</span>
      <button onclick="zoomIn()" class="text-white hover:text-purple-400 transition-colors p-2">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7"></path>
        </svg>
      </button>
      <button onclick="resetZoom()" class="text-white hover:text-purple-400 transition-colors p-2 ml-2">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
const basePrice = {{ page.base_price }};
const defaultImage = '{{ page.images[0] }}';
const embroideryPrice = {{ site.customization.embroidery_price }};
const nameEmbroideryPrice = {{ site.customization.name_embroidery_price }};
let selectedColorModifier = 0;
let selectedSizeModifier = 0;
let embroideryModifier = 0;
let nameEmbroideryModifier = 0;

// Store color-size-image mappings
const colorSizeImages = {
  {% for color in page.colors %}
  '{{ color.name }}': {
    defaultImage: '{{ color.image }}',
    sizeImages: {
      {% if color.size_images %}
      {% for size_img in color.size_images %}
      '{{ size_img.size }}': '{{ size_img.image }}'{% unless forloop.last %},{% endunless %}
      {% endfor %}
      {% endif %}
    }
  }{% unless forloop.last %},{% endunless %}
  {% endfor %}
};

function updatePrice() {
  const totalPrice = basePrice + selectedColorModifier + selectedSizeModifier + embroideryModifier + nameEmbroideryModifier;
  document.getElementById('displayPrice').textContent = totalPrice.toLocaleString('sr-RS') + ' RSD';
}

function changeMainImage(imageSrc) {
  document.getElementById('mainImage').src = imageSrc;
}

function updateImageForColorAndSize() {
  const selectedColor = document.querySelector('.color-radio:checked');
  const selectedSize = document.querySelector('.size-radio:checked');
  
  if (!selectedColor) {
    changeMainImage(defaultImage);
    return;
  }
  
  const colorName = selectedColor.value;
  const colorData = colorSizeImages[colorName];
  
  if (!colorData) {
    changeMainImage(defaultImage);
    return;
  }
  
  // If size is selected and we have a size-specific image, use it
  if (selectedSize && colorData.sizeImages && colorData.sizeImages[selectedSize.value]) {
    changeMainImage(colorData.sizeImages[selectedSize.value]);
  } 
  // Otherwise use the color's default image
  else if (colorData.defaultImage) {
    changeMainImage(colorData.defaultImage);
  } 
  // Fall back to product default
  else {
    changeMainImage(defaultImage);
  }
}

// Color selection with radio buttons
document.querySelectorAll('.color-radio').forEach(radio => {
  const label = radio.parentElement;
  const swatch = radio.nextElementSibling;
  const checkIcon = swatch.querySelector('.check-icon');
  
  if (radio.checked) {
    label.classList.add('ring-4', 'ring-purple-500', 'ring-offset-2', 'ring-offset-slate-800', 'rounded-full');
    checkIcon.classList.remove('hidden');
    selectedColorModifier = parseInt(radio.dataset.priceModifier) || 0;
    document.getElementById('selectedColorName').textContent = radio.value;
    
    // Update image based on color and size
    updateImageForColorAndSize();
    updatePrice();
  }
  
  radio.addEventListener('change', function() {
    // Remove selection from all
    document.querySelectorAll('.color-radio').forEach(r => {
      const lbl = r.parentElement;
      const sw = r.nextElementSibling;
      lbl.classList.remove('ring-4', 'ring-purple-500', 'ring-offset-2', 'ring-offset-slate-800', 'rounded-full');
      sw.querySelector('.check-icon').classList.add('hidden');
    });
    
    // Add selection to current
    if (this.checked) {
      label.classList.add('ring-4', 'ring-purple-500', 'ring-offset-2', 'ring-offset-slate-800', 'rounded-full');
      checkIcon.classList.remove('hidden');
      selectedColorModifier = parseInt(this.dataset.priceModifier) || 0;
      document.getElementById('selectedColorName').textContent = this.value;
      
      // Update image based on color and size
      updateImageForColorAndSize();
      
      updatePrice();
    }
  });
});

// Size selection with radio buttons
document.querySelectorAll('.size-radio').forEach(radio => {
  const swatch = radio.nextElementSibling;
  
  if (radio.checked) {
    swatch.classList.add('border-purple-500', 'bg-gradient-to-r', 'from-purple-600', 'to-pink-600');
    swatch.classList.remove('border-slate-600');
    selectedSizeModifier = parseInt(radio.dataset.priceModifier) || 0;
    document.getElementById('selectedSizeName').textContent = radio.value;
    updatePrice();
  }
  
  radio.addEventListener('change', function() {
    // Remove selection from all
    document.querySelectorAll('.size-swatch').forEach(s => {
      s.classList.remove('border-purple-500', 'bg-gradient-to-r', 'from-purple-600', 'to-pink-600');
      s.classList.add('border-slate-600');
    });
    
    // Add selection to current
    if (this.checked) {
      swatch.classList.add('border-purple-500', 'bg-gradient-to-r', 'from-purple-600', 'to-pink-600');
      swatch.classList.remove('border-slate-600');
      selectedSizeModifier = parseInt(this.dataset.priceModifier) || 0;
      document.getElementById('selectedSizeName').textContent = this.value;
      
      // Update image based on color and size
      updateImageForColorAndSize();
      
      updatePrice();
    }
  });
});

// Customization checkboxes
const embroideryCheckbox = document.getElementById('embroideryCheckbox');
const nameEmbroideryCheckbox = document.getElementById('nameEmbroideryCheckbox');
const nameInputContainer = document.getElementById('nameInputContainer');
const embroideryContainer = document.getElementById('embroideryContainer');

let selectedEmbroideryId = null;
let selectedEmbroideryName = '';
let selectedEmbroideryImage = '';

if (embroideryCheckbox) {
  embroideryCheckbox.addEventListener('change', function() {
    embroideryModifier = this.checked ? embroideryPrice : 0;
    if (embroideryContainer) {
      embroideryContainer.classList.toggle('hidden', !this.checked);
    }
    updatePrice();
  });
}

if (nameEmbroideryCheckbox) {
  nameEmbroideryCheckbox.addEventListener('change', function() {
    nameEmbroideryModifier = this.checked ? nameEmbroideryPrice : 0;
    if (nameInputContainer) {
      nameInputContainer.classList.toggle('hidden', !this.checked);
    }
    updatePrice();
  });
}

// Font style radio buttons
document.querySelectorAll('.font-radio').forEach(radio => {
  const swatch = radio.nextElementSibling;
  
  if (radio.checked) {
    swatch.classList.add('border-purple-500', 'bg-gradient-to-r', 'from-purple-600', 'to-pink-600');
    swatch.classList.remove('border-slate-600');
  }
  
  radio.addEventListener('change', function() {
    // Remove selection from all
    document.querySelectorAll('.font-swatch').forEach(s => {
      s.classList.remove('border-purple-500', 'bg-gradient-to-r', 'from-purple-600', 'to-pink-600');
      s.classList.add('border-slate-600');
    });
    
    // Add selection to current
    if (this.checked) {
      swatch.classList.add('border-purple-500', 'bg-gradient-to-r', 'from-purple-600', 'to-pink-600');
      swatch.classList.remove('border-slate-600');
    }
  });
});

function incrementQuantity() {
  const input = document.getElementById('quantity');
  input.value = parseInt(input.value) + 1;
}

function decrementQuantity() {
  const input = document.getElementById('quantity');
  if (parseInt(input.value) > 1) {
    input.value = parseInt(input.value) - 1;
  }
}

function addToCartWithOptions() {
  const selectedColor = document.querySelector('.color-radio:checked');
  const selectedSize = document.querySelector('.size-radio:checked');
  const quantity = parseInt(document.getElementById('quantity').value);
  
  const colorName = selectedColor ? selectedColor.value : '';
  const sizeName = selectedSize ? selectedSize.value : '';
  
  // Check customizations
  const hasEmbroidery = embroideryCheckbox && embroideryCheckbox.checked;
  const hasNameEmbroidery = nameEmbroideryCheckbox && nameEmbroideryCheckbox.checked;
  const customName = hasNameEmbroidery ? document.getElementById('customNameInput')?.value || '' : '';
  const fontStyle = hasNameEmbroidery ? document.querySelector('.font-radio:checked')?.value || 'latin' : '';
  
  // Validate name if name embroidery is checked
  if (hasNameEmbroidery && !customName.trim()) {
    alert('Molimo unesite ime ili tekst za vez.');
    document.getElementById('customNameInput').focus();
    return;
  }
  
  const totalPrice = basePrice + selectedColorModifier + selectedSizeModifier + embroideryModifier + nameEmbroideryModifier;
  
  let productTitle = '{{ page.title }}' + 
                    (colorName ? ' - ' + colorName : '') + 
                    (sizeName ? ' (' + sizeName + ')' : '');
  
  // Add customization info to title
  if (hasEmbroidery && selectedEmbroideryName) {
    productTitle += ' [Vez: ' + selectedEmbroideryName + ']';
  } else if (hasEmbroidery) {
    productTitle += ' [Vez: Logo/Slika]';
  }
  if (hasNameEmbroidery) {
    const fontLabel = fontStyle === 'cyrillic' ? 'Ćirilica' : 'Latinica';
    productTitle += ' [Vez: ' + customName + ' - ' + fontLabel + ']';
  }
  
  addToCart(productTitle, totalPrice, '{{ page.images[0] }}', '{{ page.url }}', quantity);
}

// Embroidery Gallery Functions
function openEmbroideryGallery() {
  const modal = document.getElementById('embroideryGalleryModal');
  if (modal) {
    modal.classList.remove('hidden');
    // Reset to 'all' category
    filterByCategory('all');
  }
}

function closeEmbroideryGallery() {
  const modal = document.getElementById('embroideryGalleryModal');
  if (modal) {
    modal.classList.add('hidden');
  }
}

function selectEmbroideryDesign(id, name, image) {
  selectedEmbroideryId = id;
  selectedEmbroideryName = name;
  selectedEmbroideryImage = image;
  
  // Update preview
  const preview = document.getElementById('selectedEmbroideryPreview');
  if (preview) {
    preview.innerHTML = `
      <div class="flex items-center gap-4 p-4 bg-slate-900 rounded-xl border border-purple-500">
        <div class="w-20 h-20 bg-white rounded-lg flex items-center justify-center overflow-hidden">
          <img src="${image}" alt="${name}" class="w-full h-full object-contain">
        </div>
        <div class="flex-1">
          <p class="text-white font-semibold">${name}</p>
          <p class="text-gray-400 text-sm">Izabrani dizajn</p>
        </div>
        <button onclick="clearEmbroiderySelection()" class="text-red-400 hover:text-red-300 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    `;
    preview.classList.remove('hidden');
  }
  
  // Hide gallery button
  const galleryBtn = document.querySelector('#embroideryContainer button');
  if (galleryBtn) {
    galleryBtn.classList.add('hidden');
  }
  
  closeEmbroideryGallery();
}

function clearEmbroiderySelection() {
  selectedEmbroideryId = null;
  selectedEmbroideryName = '';
  selectedEmbroideryImage = '';
  
  const preview = document.getElementById('selectedEmbroideryPreview');
  if (preview) {
    preview.classList.add('hidden');
  }
  
  const galleryBtn = document.querySelector('#embroideryContainer button');
  if (galleryBtn) {
    galleryBtn.classList.remove('hidden');
  }
}

function filterByCategory(category) {
  const items = document.querySelectorAll('.embroidery-design-item');
  const buttons = document.querySelectorAll('.category-filter-btn');
  const noResults = document.getElementById('noResultsMessage');
  
  // Update button styles
  buttons.forEach(btn => {
    if (btn.dataset.category === category) {
      btn.classList.add('border-purple-500', 'bg-purple-600');
      btn.classList.remove('bg-slate-900');
    } else {
      btn.classList.remove('border-purple-500', 'bg-purple-600');
      btn.classList.add('bg-slate-900', 'border-slate-600');
    }
  });
  
  // Filter items
  let visibleCount = 0;
  items.forEach(item => {
    if (category === 'all' || item.dataset.category === category) {
      item.style.display = 'block';
      visibleCount++;
    } else {
      item.style.display = 'none';
    }
  });
  
  // Show/hide no results message
  if (noResults) {
    noResults.classList.toggle('hidden', visibleCount > 0);
  }
}

function filterEmbroideryDesigns() {
  const searchValue = document.getElementById('embroiderySearch').value.toLowerCase();
  const activeCategory = document.querySelector('.category-filter-btn.border-purple-500').dataset.category;
  const items = document.querySelectorAll('.embroidery-design-item');
  const noResults = document.getElementById('noResultsMessage');
  
  let visibleCount = 0;
  items.forEach(item => {
    const name = item.dataset.name;
    const category = item.dataset.category;
    const matchesSearch = name.includes(searchValue);
    const matchesCategory = activeCategory === 'all' || category === activeCategory;
    
    if (matchesSearch && matchesCategory) {
      item.style.display = 'block';
      visibleCount++;
    } else {
      item.style.display = 'none';
    }
  });
  
  if (noResults) {
    noResults.classList.toggle('hidden', visibleCount > 0);
  }
}

// Image Lightbox Functions
let currentZoom = 1;
let isDragging = false;
let startX, startY, scrollLeft, scrollTop;

function openImageModal(imageSrc) {
  const modal = document.getElementById('imageLightboxModal');
  const lightboxImage = document.getElementById('lightboxImage');
  
  if (modal && lightboxImage) {
    lightboxImage.src = imageSrc;
    modal.classList.remove('hidden');
    resetZoom();
    document.body.style.overflow = 'hidden';
  }
}

function closeImageModal(event) {
  if (!event || event.target.id === 'imageLightboxModal') {
    const modal = document.getElementById('imageLightboxModal');
    if (modal) {
      modal.classList.add('hidden');
      document.body.style.overflow = '';
      currentZoom = 1;
    }
  }
}

function zoomIn() {
  currentZoom = Math.min(currentZoom + 0.25, 3);
  updateZoom();
}

function zoomOut() {
  currentZoom = Math.max(currentZoom - 0.25, 0.5);
  updateZoom();
}

function resetZoom() {
  currentZoom = 1;
  updateZoom();
}

function updateZoom() {
  const lightboxImage = document.getElementById('lightboxImage');
  const zoomLevel = document.getElementById('zoomLevel');
  
  if (lightboxImage) {
    lightboxImage.style.transform = `scale(${currentZoom})`;
    lightboxImage.style.cursor = currentZoom > 1 ? 'grab' : 'default';
  }
  
  if (zoomLevel) {
    zoomLevel.textContent = `${Math.round(currentZoom * 100)}%`;
  }
}

// Enable dragging when zoomed
const imageContainer = document.getElementById('imageContainer');

if (imageContainer) {
  imageContainer.addEventListener('mousedown', function(e) {
    if (currentZoom > 1) {
      isDragging = true;
      imageContainer.style.cursor = 'grabbing';
      startX = e.pageX - imageContainer.offsetLeft;
      startY = e.pageY - imageContainer.offsetTop;
      scrollLeft = imageContainer.scrollLeft;
      scrollTop = imageContainer.scrollTop;
    }
  });

  imageContainer.addEventListener('mouseleave', function() {
    isDragging = false;
    if (currentZoom > 1) {
      imageContainer.style.cursor = 'grab';
    }
  });

  imageContainer.addEventListener('mouseup', function() {
    isDragging = false;
    if (currentZoom > 1) {
      imageContainer.style.cursor = 'grab';
    }
  });

  imageContainer.addEventListener('mousemove', function(e) {
    if (!isDragging) return;
    e.preventDefault();
    const x = e.pageX - imageContainer.offsetLeft;
    const y = e.pageY - imageContainer.offsetTop;
    const walkX = (x - startX) * 2;
    const walkY = (y - startY) * 2;
    imageContainer.scrollLeft = scrollLeft - walkX;
    imageContainer.scrollTop = scrollTop - walkY;
  });
}

// Keyboard shortcuts for zoom
document.addEventListener('keydown', function(event) {
  const modal = document.getElementById('imageLightboxModal');
  if (modal && !modal.classList.contains('hidden')) {
    if (event.key === 'Escape') {
      closeImageModal();
    } else if (event.key === '+' || event.key === '=') {
      zoomIn();
    } else if (event.key === '-') {
      zoomOut();
    } else if (event.key === '0') {
      resetZoom();
    }
  }
});

</script>
